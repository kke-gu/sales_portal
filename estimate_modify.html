<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>견적서 수정 | 영업 지원 포털</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nanum+Barun+Gothic:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="style.css" />
</head>
<body class="page-home">
    <header class="site-header site-header--home">
        <a href="index.html" class="brand" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: 0.75rem;">
            <span class="brand-mark"><span class="m-letter">m</span><span class="tm-symbol">®</span></span>
            <div>
                <p class="brand-label">맑은소프트</p>
                <p class="brand-sub">영업 지원 포털</p>
            </div>
        </a>

        <nav class="main-nav">
            <a href="index.html" class="nav-pill">홈</a>
            <a href="estimate.html" class="nav-pill">견적 작성</a>
            <a href="estimate_list.html" class="nav-pill active">진행현황</a>
        </nav>

        <div class="header-cta">
            <a class="btn btn-icon" href="assets/회사소개서.pdf" download>
                <span class="material-icons">download</span>
                회사소개서
            </a>
            <a class="btn btn-icon" href="https://www.malgnsoft.com/" target="_blank" rel="noopener noreferrer">
                <span class="material-icons">home</span>
                대표 홈페이지
            </a>
            <a class="btn btn-icon" href="https://help.malgnsoft.com/main/index.jsp" target="_blank" rel="noopener noreferrer">
                <span class="material-icons">headset_mic</span>
                고객센터
            </a>
            <div id="userInfo" style="display: none;">
                <a id="userName" href="profile.html" style="margin-right: 1rem; text-decoration: none; color: inherit; cursor: pointer;"></a>
                <button type="button" class="btn secondary" onclick="Auth.logout()">로그아웃</button>
            </div>
            <a id="loginBtn" href="login.html" class="btn secondary" style="display: none; margin-left: 1rem;">로그인</a>
        </div>
    </header>

    <main class="estimate-main">
        <!-- 고객사 정보 (견적서 외부) -->
        <section class="customer-info-section" style="background: #f9fafb; padding: 1.5rem; border-radius: 8px; margin-bottom: 2rem; border: 1px solid #e5e7eb;">
            <h2 style="font-size: 1.25rem; margin-bottom: 1rem; color: #1f2937;">고객사 정보</h2>
            <form id="customerInfoForm">
                <div class="form-grid">
                    <label>
                        <span class="label-text">고객사명 <span class="required">*</span></span>
                        <input type="text" name="customerName" placeholder="고객사명 입력" required />
                        <span class="error-message" id="error-customerName"></span>
                    </label>
                    <label class="label-inline">
                        <span class="label-text">담당자명 <span class="required">*</span> / 직책</span>
                        <div class="inline-inputs">
                            <input type="text" name="customerManager" placeholder="담당자명 입력" required />
                            <input type="text" name="customerPosition" placeholder="직책 입력" />
                        </div>
                        <span class="error-message" id="error-customerManager"></span>
                    </label>
                    <label>
                        <span class="label-text">연락처 <span class="required">*</span></span>
                        <input type="tel" name="customerContact" placeholder="연락처 입력" required />
                        <span class="error-message" id="error-customerContact"></span>
                    </label>
                    <label>
                        <span class="label-text">이메일 <span class="required">*</span></span>
                        <input type="email" name="customerEmail" placeholder="이메일 입력" required />
                        <span class="error-message" id="error-customerEmail"></span>
                    </label>
                </div>
                <div class="checkbox-group" style="margin-top: 1rem;">
                    <p class="checkbox-label" style="margin-bottom: 0.5rem;">사용 목적</p>
                    <div class="checkbox-row">
                        <label>
                            <input type="checkbox" name="purpose" value="학원/학교" />
                            <span>학원/학교</span>
                        </label>
                        <label>
                            <input type="checkbox" name="purpose" value="개인 사업자" />
                            <span>개인 사업자</span>
                        </label>
                        <label>
                            <input type="checkbox" name="purpose" value="내부 교육용" />
                            <span>내부 교육용</span>
                        </label>
                        <label>
                            <input type="checkbox" name="purpose" value="내일배움카드" />
                            <span>내일배움카드</span>
                        </label>
                        <label>
                            <input type="checkbox" name="purpose" value="공공기관 사용" />
                            <span>공공기관 사용</span>
                        </label>
                        <label>
                            <input type="checkbox" name="purpose" value="기타" />
                            <span>기타</span>
                        </label>
                    </div>
                </div>
                <div class="form-grid" style="margin-top: 1rem;">
                    <label>
                        등록일자
                        <input type="text" id="registeredDate" readonly style="background: #f9fafb;" />
                    </label>
                    <label>
                        현황
                        <select id="statusSelect" class="status-select">
                            <option value="draft">임시 저장</option>
                            <option value="received">접수</option>
                            <option value="writing">작성중</option>
                            <option value="sent">발송 완료</option>
                            <option value="negotiating">협의 중</option>
                            <option value="confirmed">계약 확정</option>
                            <option value="completed">계약완료</option>
                        </select>
                    </label>
                </div>
            </form>
        </section>

        <form class="estimate-form" id="estimateForm">
            <!-- 견적서 헤더 -->
            <section class="quote-header">
                <div class="quote-header-top">
                    <div class="quote-logo">
                        <span class="brand-mark"><span class="m-letter">m</span><span class="tm-symbol">®</span></span>
                        <div>
                            <p class="brand-label">맑은소프트</p>
                            <p class="brand-sub">보통 사람들이 만드는 위대한 기업</p>
                        </div>
                    </div>
                    <h1>견적서</h1>
                </div>
                <div class="quote-company-info">
                    <p>서울특별시 구로구 디지털로 288</p>
                    <p>tel. 02-857-5445 | fax. 02-6442-7010</p>
                    <p>업태/종목_ 서비스/소프트웨어·원격교육컨텐츠개발및공급</p>
                    <p>사업자등록번호_ 119-86-39050 | 상호_ ㈜맑은소프트</p>
                    <p>대표자_ 하근호</p>
                </div>
            </section>

            <!-- 수신 정보 -->
            <section class="form-section">
                <h2>수신</h2>
                <div class="form-grid">
                    <label>
                        <span class="label-text">수신자 <span class="required">*</span></span>
                        <input type="text" name="recipient" placeholder="수신자명 입력" required />
                        <span class="error-message" id="error-recipient"></span>
                    </label>
                    <label>
                        참조
                        <input type="text" name="reference" placeholder="참조 정보 입력" />
                    </label>
                </div>
            </section>

            <!-- 견적 기본 정보 -->
            <section class="form-section">
                <h2>견적 기본 정보</h2>
                <div class="form-grid">
                    <label>
                        <span class="label-text">견적 명칭 <span class="required">*</span></span>
                        <input type="text" name="quoteName" placeholder="견적 명칭 입력" required />
                        <span class="error-message" id="error-quoteName"></span>
                    </label>
                    <label>
                        견적 일자
                        <input type="date" name="quoteDate" required />
                    </label>
                </div>
                <div class="quote-total">
                    <div class="total-item">
                        <span>계약 총액</span>
                        <span id="totalWithoutVAT">0원 (VAT 별도)</span>
                    </div>
                    <div class="total-item">
                        <span></span>
                        <span id="totalWithVAT">0원 (VAT 포함)</span>
                    </div>
                </div>
            </section>

            <!-- 견적 항목 -->
            <section class="form-section">
                <div class="section-header">
                    <h2>견적 항목</h2>
                    <div class="section-actions">
                        <button type="button" class="btn secondary" id="saveTemplateBtn">템플릿 저장</button>
                        <button type="button" class="btn secondary" id="loadTemplateBtn">템플릿 불러오기</button>
                        <button type="button" class="btn secondary" id="addItemBtn">항목 추가</button>
                    </div>
                </div>
                <div class="quote-items-table">
                    <table>
                        <thead>
                            <tr>
                                <th style="width: 30px;"></th>
                                <th>구분</th>
                                <th>세부 항목</th>
                                <th class="period-col">기본계약<br>기간(월)</th>
                                <th>수량</th>
                                <th>단가</th>
                                <th>공급가액</th>
                                <th>비고</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="quoteItems">
                        </tbody>
                    </table>
                </div>
                <div class="quote-items-total">
                    <div class="items-total-row">
                        <span>계약 총액</span>
                        <span id="itemsTotalAmount">0원</span>
                    </div>
                </div>
            </section>

            <!-- 결제 및 담당자 안내 -->
            <section class="form-section">
                <h2>결제 및 담당자 안내</h2>
                <label>
                    결제 정보
                    <textarea name="paymentInfo" rows="1">신한은행 100-027-164841 예금주 (주)맑은소프트</textarea>
                </label>
                <label>
                    입금 관련
                    <textarea name="depositInfo" rows="1">계약금은 없으며, 개발 검수 후 7일 이내 계약 총액 입금</textarea>
                </label>
                <div class="form-grid">
                    <label>
                        견적 담당자 이름
                        <input type="text" name="managerName" id="managerName" readonly />
                    </label>
                    <label>
                        직책
                        <input type="text" name="managerPosition" id="managerPosition" readonly />
                    </label>
                    <label>
                        연락처
                        <input type="tel" name="managerContact" id="managerContact" />
                    </label>
                    <label>
                        이메일
                        <input type="email" name="managerEmail" id="managerEmail" />
                    </label>
                </div>
                <label>
                    유효기간
                    <textarea name="validityPeriod" rows="1">본 견적서의 유효 기간은 견적일자로부터 7일이며, 이후 가격정책 변경시행시 견적내용이 달라질 수 있습니다.</textarea>
                </label>
            </section>

            <div class="form-actions">
                <button type="submit" class="btn primary">견적서 수정</button>
                <button type="button" class="btn secondary" id="previewBtn">미리보기</button>
                <button type="button" class="btn secondary" id="deleteBtn">삭제</button>
                <a class="btn secondary" href="estimate_list.html">목록으로</a>
            </div>
        </form>

        <!-- 템플릿 모달 -->
        <div id="templateModal" class="modal" style="display: none;">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 id="modalTitle">템플릿 관리</h3>
                    <button type="button" class="modal-close" id="closeModal">×</button>
                </div>
                <div class="modal-body">
                    <div id="templateList" class="template-list"></div>
                    <div id="templateForm" class="template-form" style="display: none;">
                        <label>
                            템플릿 이름
                            <input type="text" id="templateName" placeholder="템플릿 이름 입력" />
                        </label>
                        <div id="templateItemsContainer" style="display: none; margin-top: 1.5rem;">
                            <h4 style="margin: 0 0 1rem 0; font-size: 1rem;">견적 항목</h4>
                            <div class="quote-items-table" style="max-height: 400px; overflow-y: auto;">
                                <table>
                                    <thead>
                                        <tr>
                                            <th style="width: 30px;"></th>
                                            <th>구분</th>
                                            <th>세부 항목</th>
                                            <th class="period-col">기본계약<br>기간(월)</th>
                                            <th>수량</th>
                                            <th>단가</th>
                                            <th>공급가액</th>
                                            <th>비고</th>
                                            <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="templateItems">
                                    </tbody>
                                </table>
                            </div>
                            <button type="button" class="btn secondary" id="addTemplateItemBtn" style="margin-top: 1rem;">항목 추가</button>
                        </div>
                        <div class="form-actions" style="margin-top: 1.5rem;">
                            <button type="button" class="btn primary" id="confirmTemplateBtn">확인</button>
                            <button type="button" class="btn secondary" id="cancelTemplateBtn">취소</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="auth.js"></script>
    <script>
        Auth.requireAuth();
    </script>
    <script src="script.js"></script>
    <script src="estimate.js"></script>
    <script src="estimate_modify.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            if (Auth.isAuthenticated()) {
                document.getElementById('userInfo').style.display = 'flex';
                const userName = document.getElementById('userName');
                const profileData = localStorage.getItem(`profile_${Auth.getCurrentUser()}`);
                let profile = {};
                if (profileData) {
                    profile = JSON.parse(profileData);
                    userName.textContent = (profile.name || Auth.getCurrentUser()) + '님';
                } else {
                    userName.textContent = Auth.getCurrentUser() + '님';
                }
                
                // 담당자 정보 자동 입력
                document.getElementById('managerName').value = profile.name || Auth.getCurrentUser() || '';
                document.getElementById('managerPosition').value = profile.position || '';
                document.getElementById('managerContact').value = profile.phone || '';
                document.getElementById('managerEmail').value = profile.email || '';
                if (document.getElementById('loginBtn')) {
                    document.getElementById('loginBtn').style.display = 'none';
                }
            } else {
                if (document.getElementById('loginBtn')) {
                    document.getElementById('loginBtn').style.display = 'inline-flex';
                }
            }
        });
    </script>
</body>
</html>
